# Transaction Model

## Interface: `ITransaction`

Base interface for all transactions.

```typescript
export interface ITransaction {
  transactionId: string; // UUID v5 (Deterministic Hash)
  accountId: string; // Foreign Key (Source Account)
  categoryId?: string; // Foreign Key
  tagIds: string[]; // Foreign Keys

  amount: number;
  currency: ICurrency;
  date: Date;
  description: string | null;
  transactionType: TransactionType;
}
```

## Client-Side Representation
- **Flat Structure**: The transaction object sent to the client is "flat" and contains only Foreign Keys (`categoryId`, `accountId`) rather than full objects.
- **Lookups**: The frontend (`TransactionRow.tsx`, etc.) is responsible for resolving these IDs to names or objects (e.g., `getCategoryColor(tx.categoryId)`, `getAccountName(tx.accountId)`).
- **Discrepancy**: Previous iterations of the client code attempted to access `transaction.category` or `transaction.account`, which do not exist on the interface.


## Date Handling
-   **Firestore Storage**: Stored as a `Timestamp`.
-   **Application Model**: Defined as `Date`.
-   **Conversion**:
    -   **Read**: Must convert `Timestamp` to `Date` (e.g., `.toDate()`).
    -   **Write**: Firestore client SDK handles `Date` -> `Timestamp` conversion automatically.
    -   **API**: Serialized as ISO 8601 string.

## API Serialization
While the internal model uses `Date` objects, the API **MUST** serialize these to **ISO 8601 Strings** (`YYYY-MM-DDTHH:mm:ss.sssZ`) before sending to the client.
- **Firestore Behavior**: The Firestore Admin SDK returns `Timestamp` objects (or plain objects with `_seconds`).
- **Server Responsibility**: The server (specifically `resolveTransactionReferences` in `firebase.ts`) is responsible for converting these to ISO strings.
- **Client Expectation**: The frontend expects `date` to be a string.

## Lifecycle & Integrity

### Deletion
Deleting a transaction requires a **Dual-Delete** operation to maintain database integrity:
1.  **Global Reference**: The document in `users/{userId}/transactions/{transactionId}` must be deleted.
2.  **Nested Document**: The actual data document in `.../accounts/{accountId}/transactions/{transactionId}` must be deleted.

Failure to delete the global reference will result in "ghost" transactions appearing in the "All Transactions" list that fail to resolve (loading errors).

## Mutability

Transactions support updates, but strict rules apply to which fields can be modified to preserve data integrity and audit trails.

### Changeable Fields
- **`amount`**: The transaction value.
- **`date`**: The transaction date.
- **`description`**: User-provided description.
- **`transactionType`**: The classification of the transaction (e.g., `GENERAL`, `TRADE`).
- **`categoryId`**: (Implicitly mutable as it's not part of the identity hash for manual transactions, though user request focused on core fields).

### Unchangeable Fields
- **`accountId`**: Moving transactions between accounts is NOT supported via update. Requires delete & re-create.
- **`currency`**: Tied to the account's currency or the original transaction event.
- **`transactionId`**: The unique identifier is immutable.
- **`userId`**: Transactions cannot be moved between users.
- **`tagIds`**: Deprecated and unchangeable.

### Update Logic
Updates must be applied to the **Nested Document** (`accounts/{accountId}/transactions/{transactionId}`). The Global Reference (`users/{userId}/transactions/{transactionId}`) typically only stores a pointer (`RefTxId`) and does not need updating unless it caches data (which it currently does not).

## ID Generation

Transactions use **deterministic IDs** (UUID v5) to prevent duplicates when re-importing the same statement.

- **Namespace**: A constant UUID (`1b671a64-40d5-491e-99b0-da01ff1f3341`) is used as the namespace.
- **Hash Input**: The ID is generated by hashing a pipe-delimited string of immutable transaction fields.
  - **General**: `accountId|userId|amount|currency|date|description|transactionType|merchantName|seed`
  - **Trade**: `accountId|userId|amount|currency|date|description|transactionType|instrumentId|quantity|price|seed`
  - **Transfer**: `accountId|userId|amount|currency|date|description|transactionType|seed`
- **Exclusions**:
  - **Mutable Fields**: `categoryId` and `tagIds` are excluded so that categorizing a transaction doesn't change its ID (which would duplicate it on re-import).
  - **Linked IDs**: `linkedTransactionId` is excluded from `TransferTransaction` hash to avoid circular dependencies and allow linking after instantiation.

### Manual Transactions
Transactions created manually (e.g., via the API or UI) use **UUID v4 (Random)**.
- **Reasoning**: Manual transactions lack the immutable external context (like a bank statement line item) required for reliable deterministic hashing.
- **Fallback**: If a client does not provide a `transactionId`, the server generates a random UUID v4.

## Transaction Types

```typescript
export enum TransactionType {
  Unknown = 'UNKNOWN',
  Invalid = 'INVALID',
  General = 'GENERAL',
  Trade = 'TRADE',
  Transfer = 'TRANSFER',
  Deposit = 'DEPOSIT',
  Withdrawal = 'WITHDRAWAL',
  Fees = 'FEES',
  Other = 'OTHER',
  Reconciliation = 'RECONCILIATION'
}
```

- **General**: Regular income/expense transactions. Includes `merchant` field. Also used for **Deposit**, **Withdrawal**, and **Fees**.
- **Trade**: Investment trades (Buy/Sell). Includes `instrumentId`, `quantity`, and `price`.
- **Transfer**: Movement of funds between accounts. Includes `linkedTransactionId`.

## Transfer Logic
Transfers are modeled using a **Linked Transaction** pattern to support multi-currency and multi-institution transfers while maintaining single-entry records for each account.

- **Structure**: A transfer consists of **two separate** `TransferTransaction` records:
  1.  **Source Transaction**: Belongs to the source account (negative amount).
  2.  **Destination Transaction**: Belongs to the destination account (positive amount).
- **Linking**: Both transactions share a `linkedTransactionId` (a UUID) that connects them.
- **Multi-Currency**: Each transaction records the amount in its own account's currency. An optional `exchangeRate` field on the transaction can store the rate used.
- **Creation**: Use the static helper `TransferTransaction.createTransferPair(...)` to generate both transactions simultaneously with correct linking.

This approach ensures that each account's ledger is self-contained and accurate (single-entry) while logically connecting the flow of funds.

## Reimbursements & Split Transactions
Reimbursements (e.g., splitting a bill) are modeled as **separate transactions** to preserve the audit trail.
- **Original Expense**: A `Withdrawal` (or `General`) transaction representing the full payment.
- **Reimbursement**: A separate `Deposit` (or `General`) transaction representing the incoming funds.
Do not reduce the original expense amount; track both flows explicitly.

## Classes

- `GeneralTransaction`: Implements `ITransaction`. Used for `General`, `Deposit`, `Withdrawal`, and `Fees` types. Constructor allows dynamic type assignment.
- `TradeTransaction`: Implements `ITransaction` for trades.
- `TransferTransaction`: Implements `ITransaction` for transfers. Contains `linkedTransactionId` and optional `exchangeRate`.
